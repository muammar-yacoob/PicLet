<!DOCTYPE html>
<html lang="en" data-piclet data-width="400" data-height="480">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Recolor</title>
  <link rel="stylesheet" href="/css/theme.css">
  <script src="/js/piclet.js"></script>
  <style>
    .preview-area{flex:1;display:flex;align-items:center;justify-content:center;background:var(--bg2);border-radius:6px;min-height:140px;overflow:hidden;position:relative}
    .preview-area::before{content:'';position:absolute;inset:0;background:repeating-conic-gradient(#1a1a1d 0% 25%, #222 0% 50%) 50%/16px 16px;z-index:0}
    .preview-area img{max-width:100%;max-height:100%;object-fit:contain;position:relative;z-index:1}
    .preview-area .placeholder{position:relative;z-index:1;font-size:11px;color:var(--txt3)}
    .preview-area .mini-sp{width:16px;height:16px;border:2px solid var(--bg3);border-top-color:var(--acc);border-radius:50%;animation:s .5s linear infinite;position:relative;z-index:1}
    .preview-info{font-size:10px;color:var(--txt3);text-align:center;margin-top:4px;height:14px}
    .controls{display:flex;flex-direction:column;gap:10px}
    .color-section{display:flex;align-items:center;gap:10px}
    .color-section label{font-size:11px;color:var(--txt3);width:50px;flex-shrink:0}
    .color-input-wrap{flex:1;display:flex;align-items:center;gap:8px}
    .color-preview{width:28px;height:28px;border-radius:4px;border:1px solid var(--brd);cursor:pointer;flex-shrink:0;position:relative}
    .color-preview input[type="color"]{position:absolute;opacity:0;inset:0;width:100%;height:100%;cursor:pointer}
    .color-input-wrap input[type="text"]{flex:1;padding:6px 10px;background:var(--bg2);border:1px solid var(--brd);border-radius:5px;color:var(--txt);font:inherit;font-size:12px}
    .color-input-wrap input[type="text"]:focus{outline:none;border-color:var(--acc)}
    .arrow{font-size:16px;color:var(--txt3)}
    .fuzz-row{display:flex;align-items:center;gap:10px}
    .fuzz-row label{font-size:11px;color:var(--txt3);width:50px;flex-shrink:0}
    .fuzz-row input[type="number"]{width:50px;padding:6px;background:var(--bg2);border:1px solid var(--brd);border-radius:5px;color:var(--txt);font:inherit;font-size:12px;text-align:center}
    .fuzz-row input[type="number"]:focus{outline:none;border-color:var(--acc)}
    .fuzz-row input[type="range"]{flex:1;height:4px;background:var(--bg3);border-radius:3px;-webkit-appearance:none}
    .fuzz-row input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--acc);border-radius:50%;cursor:pointer}
    .detected-hint{font-size:10px;color:var(--txt3);margin-top:-6px;padding-left:60px}
  </style>
</head>
<body>
<div class="app">
  <div class="hd"><b>PicLet</b><span>Recolor</span></div>
  <div class="meta">
    <div>File<b id="fn">-</b></div>
    <div>Size<b id="sz">-</b></div>
  </div>
  <!-- Form -->
  <div id="F" class="form">
    <div class="preview-area" id="pA">
      <span class="placeholder">Adjust to preview</span>
    </div>
    <div class="preview-info" id="pI"></div>
    <div class="controls">
      <div class="color-section">
        <label>From</label>
        <div class="color-input-wrap">
          <div class="color-preview" id="fP" style="background:#ffffff">
            <input type="color" id="fC" value="#ffffff">
          </div>
          <input type="text" id="fT" value="#ffffff" placeholder="#ffffff">
        </div>
        <span class="arrow">→</span>
        <div class="color-input-wrap">
          <div class="color-preview" id="tP" style="background:#000000">
            <input type="color" id="tC" value="#000000">
          </div>
          <input type="text" id="tT" value="#000000" placeholder="#000000">
        </div>
        <label style="text-align:right">To</label>
      </div>
      <div class="detected-hint" id="dH"></div>
      <div class="fuzz-row" data-tip="Color matching tolerance - higher matches more similar colors">
        <label>Tolerance</label>
        <input type="number" id="fN" min="0" max="100" value="10">
        <input type="range" id="fR" min="0" max="100" value="10">
      </div>
    </div>
    <div class="btns">
      <button class="btn btn-g" onclick="PicLet.close()">Cancel</button>
      <button class="btn btn-p" onclick="apply()">Apply</button>
    </div>
  </div>
  <!-- Loading state -->
  <div class="ld" id="L"><div class="sp"></div><span id="lT">Recoloring...</span></div>
  <!-- Log -->
  <div class="log" id="G"></div>
  <!-- Done state -->
  <div class="dn" id="D">
    <h4 id="dT"></h4>
    <p id="dM"></p>
    <div class="btns" style="width:100%;margin-top:8px">
      <button class="btn btn-p" onclick="PicLet.close()">Done</button>
    </div>
  </div>
</div>
<script>
const { $, log, fetchJson, postJson } = PicLet;
const pA = $('pA'), pI = $('pI');
const fC = $('fC'), fT = $('fT'), fP = $('fP');
const tC = $('tC'), tT = $('tT'), tP = $('tP');
const fN = $('fN'), fR = $('fR');

let previewTimeout = null;
let isSliding = false;
let lastPreviewOpts = null;

// From color
fC.oninput = () => {
  fT.value = fC.value;
  fP.style.background = fC.value;
  schedulePreview();
};
fT.oninput = () => {
  if (/^#[0-9a-fA-F]{6}$/.test(fT.value)) {
    fC.value = fT.value;
    fP.style.background = fT.value;
    schedulePreview();
  }
};
fT.onblur = schedulePreview;

// To color
tC.oninput = () => {
  tT.value = tC.value;
  tP.style.background = tC.value;
  schedulePreview();
};
tT.oninput = () => {
  if (/^#[0-9a-fA-F]{6}$/.test(tT.value)) {
    tC.value = tT.value;
    tP.style.background = tT.value;
    schedulePreview();
  }
};
tT.onblur = schedulePreview;

// Fuzz
fN.oninput = () => { fR.value = fN.value; schedulePreview(); };
fR.oninput = () => { fN.value = fR.value; };
fR.addEventListener('mousedown', () => { isSliding = true; });
fR.addEventListener('mouseup', () => { isSliding = false; schedulePreview(); });
fR.addEventListener('mouseleave', () => { if (isSliding) { isSliding = false; schedulePreview(); } });

// Get current options
function getOptions() {
  return {
    fromColor: fT.value || '#ffffff',
    toColor: tT.value || '#000000',
    fuzz: +fN.value || 10
  };
}

// Check if options changed
function optionsChanged() {
  const current = JSON.stringify(getOptions());
  if (current === lastPreviewOpts) return false;
  lastPreviewOpts = current;
  return true;
}

// Schedule preview
function schedulePreview() {
  if (isSliding) return;
  if (previewTimeout) clearTimeout(previewTimeout);
  previewTimeout = setTimeout(() => {
    if (!isSliding && optionsChanged()) {
      generatePreview();
    }
  }, 300);
}

// Generate preview
async function generatePreview() {
  pA.innerHTML = '<div class="mini-sp"></div>';
  pI.textContent = '';

  try {
    const result = await postJson('/api/preview', getOptions());

    if (result.success && result.imageData) {
      const img = document.createElement('img');
      img.src = result.imageData;
      img.alt = 'Preview';
      pA.innerHTML = '';
      pA.appendChild(img);
      pI.textContent = result.width && result.height ? `${result.width}×${result.height}` : '';
    } else {
      pA.innerHTML = '<span class="placeholder">' + (result.error || 'Preview failed') + '</span>';
      pI.textContent = '';
    }
  } catch (e) {
    pA.innerHTML = '<span class="placeholder">Preview error</span>';
    pI.textContent = '';
  }
}

// Load initial data
fetchJson('/api/info').then(d => {
  $('fn').textContent = d.fileName;
  $('sz').textContent = d.width + '×' + d.height;

  if (d.borderColor) {
    $('dH').textContent = 'Detected corner: ' + d.borderColor;
  }

  if (d.defaults) {
    const from = d.defaults.fromColor || '#ffffff';
    fC.value = from.startsWith('#') ? from : '#ffffff';
    fT.value = from;
    fP.style.background = from;

    const to = d.defaults.toColor || '#000000';
    tC.value = to.startsWith('#') ? to : '#000000';
    tT.value = to;
    tP.style.background = to;

    fN.value = fR.value = d.defaults.fuzz || 10;
  }

  setTimeout(generatePreview, 100);
});

// Apply
async function apply() {
  $('F').classList.add('hide');
  $('L').classList.add('on');
  $('G').classList.add('on');

  try {
    const result = await postJson('/api/process', getOptions());
    if (result.logs) {
      result.logs.forEach(l => log('G', l.type[0], l.message));
    }

    $('L').classList.remove('on');
    $('D').classList.add('on', result.success ? 'ok' : 'err');
    $('dT').textContent = result.success ? 'Done' : 'Failed';
    $('dM').textContent = result.success ? result.output : result.error;
  } catch (e) {
    log('G', 'e', e.message);
    $('L').classList.remove('on');
    $('D').classList.add('on', 'err');
    $('dT').textContent = 'Error';
    $('dM').textContent = e.message;
  }
}
</script>
</body>
</html>
