<!DOCTYPE html>
<html data-piclet data-width="400" data-height="420">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Extract Frames</title>
  <link rel="stylesheet" href="/css/theme.css">
  <script src="/js/piclet.js"></script>
  <style>
    .preview-area{flex:1;display:flex;align-items:center;justify-content:center;background:var(--bg2);border-radius:6px;min-height:160px;overflow:hidden;position:relative}
    .preview-area::before{content:'';position:absolute;inset:0;background:repeating-conic-gradient(#1a1a1d 0% 25%, #222 0% 50%) 50%/16px 16px;z-index:0}
    .preview-area img{max-width:100%;max-height:100%;object-fit:contain;position:relative;z-index:1}
    .preview-area .placeholder{position:relative;z-index:1;font-size:11px;color:var(--txt3)}
    .preview-area .mini-sp{width:16px;height:16px;border:2px solid var(--bg3);border-top-color:var(--acc);border-radius:50%;animation:s .5s linear infinite;position:relative;z-index:1}
    .preview-info{font-size:10px;color:var(--txt3);text-align:center;margin-top:4px;height:14px}
    .frame-nav{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:8px}
    .frame-nav button{width:32px;height:32px;border-radius:6px;border:none;background:var(--bg3);color:var(--txt2);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .frame-nav button:hover{background:var(--acc);color:#fff}
    .frame-nav button:disabled{opacity:0.3;cursor:not-allowed}
    .frame-nav span{font-size:12px;color:var(--txt2);min-width:80px;text-align:center}
    .info-box{background:var(--bg2);border-radius:6px;padding:12px;margin-top:8px;text-align:center}
    .info-box .count{font-size:24px;font-weight:600;color:var(--acc2)}
    .info-box .label{font-size:11px;color:var(--txt3);margin-top:2px}
  </style>
</head>
<body>
<div class="app">
  <div class="hd"><b>PicLet</b><span>Extract Frames</span></div>
  <div class="meta">
    <div>File<b id="fn">-</b></div>
    <div>Size<b id="sz">-</b></div>
  </div>
  <!-- Form -->
  <div id="F" class="form">
    <div class="preview-area" id="pA">
      <span class="placeholder">Loading...</span>
    </div>
    <div class="preview-info" id="pI"></div>
    <div class="frame-nav">
      <button id="bP" title="Previous frame">&lt;</button>
      <span id="fN">Frame 1 / 1</span>
      <button id="bN" title="Next frame">&gt;</button>
    </div>
    <div class="info-box">
      <div class="count" id="fC">0</div>
      <div class="label">frames will be extracted as PNG files</div>
    </div>
    <div class="btns">
      <button class="btn btn-g" onclick="PicLet.close()">Cancel</button>
      <button class="btn btn-p" onclick="apply()">Extract All</button>
    </div>
  </div>
  <!-- Loading state -->
  <div class="ld" id="L"><div class="sp"></div><span id="lT">Extracting...</span></div>
  <!-- Log -->
  <div class="log" id="G"></div>
  <!-- Done state -->
  <div class="dn" id="D">
    <h4 id="dT"></h4>
    <p id="dM"></p>
    <div class="btns" style="width:100%;margin-top:8px">
      <button class="btn btn-p" onclick="PicLet.close()">Done</button>
    </div>
  </div>
</div>
<script>
const { $, log, fetchJson, postJson } = PicLet;
const pA = $('pA'), pI = $('pI'), fN = $('fN'), fC = $('fC');
const bP = $('bP'), bN = $('bN');

let frameCount = 1;
let currentFrame = 0;

// Update frame display
function updateFrameDisplay() {
  fN.textContent = `Frame ${currentFrame + 1} / ${frameCount}`;
  bP.disabled = currentFrame === 0;
  bN.disabled = currentFrame >= frameCount - 1;
}

// Load frame preview
async function loadFrame(index) {
  pA.innerHTML = '<div class="mini-sp"></div>';
  pI.textContent = '';

  try {
    const result = await postJson('/api/preview', { frameIndex: index });
    if (result.success && result.imageData) {
      const img = document.createElement('img');
      img.src = result.imageData;
      img.alt = `Frame ${index + 1}`;
      pA.innerHTML = '';
      pA.appendChild(img);
      pI.textContent = result.width && result.height ? `${result.width}x${result.height}` : '';
    } else {
      pA.innerHTML = '<span class="placeholder">' + (result.error || 'Preview failed') + '</span>';
    }
  } catch (e) {
    pA.innerHTML = '<span class="placeholder">Preview error</span>';
  }
}

// Navigation
bP.onclick = () => {
  if (currentFrame > 0) {
    currentFrame--;
    updateFrameDisplay();
    loadFrame(currentFrame);
  }
};

bN.onclick = () => {
  if (currentFrame < frameCount - 1) {
    currentFrame++;
    updateFrameDisplay();
    loadFrame(currentFrame);
  }
};

// Load initial data
fetchJson('/api/info').then(d => {
  $('fn').textContent = d.fileName;
  $('sz').textContent = d.width + 'x' + d.height;
  frameCount = d.defaults?.frameCount || 1;
  fC.textContent = frameCount;
  updateFrameDisplay();
  loadFrame(0);
});

// Apply
async function apply() {
  $('F').classList.add('hide');
  $('L').classList.add('on');
  $('G').classList.add('on');

  try {
    const result = await postJson('/api/process', {});
    if (result.logs) {
      result.logs.forEach(l => log('G', l.type[0], l.message));
    }

    $('L').classList.remove('on');
    $('D').classList.add('on', result.success ? 'ok' : 'err');
    $('dT').textContent = result.success ? 'Done' : 'Failed';
    $('dM').textContent = result.success ? result.output : result.error;
  } catch (e) {
    log('G', 'e', e.message);
    $('L').classList.remove('on');
    $('D').classList.add('on', 'err');
    $('dT').textContent = 'Error';
    $('dM').textContent = e.message;
  }
}
</script>
</body>
</html>
